<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Art Connections - Visualizing Art</title>

    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="preconnect" href="https://storage.googleapis.com" crossorigin />
    <link rel="dns-prefetch" href="//gtvault.sharepoint.com///storage.googleapis.com" />

    <style>
        .viz-wrapper{position:relative;border:1px solid var(--border);border-radius:12px;background:var(--card);
            box-shadow:0 20px 40px rgba(0,0,0,.6);padding:1rem;max-width:100%;overflow:hidden}
        .viz-header{color:var(--ink);margin-bottom:1rem}
        .viz-header p{color:var(--muted);margin:.25rem 0 0;font-size:.95rem;line-height:1.4;max-width:80ch}
        #viz-root{width:100%;max-width:100%;overflow:hidden}
        .node text{fill:var(--ink);font:10px/1.3 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
            pointer-events:none;text-shadow:0 0 4px rgba(0,0,0,.8),0 0 10px rgba(0,0,0,.8)}
        .node image{cursor:grab}
        .drag-handle{fill:rgba(255,255,255,.03)}

        /* Tooltip that shows the big size of artwork */
        .img-tooltip{
            position:fixed; z-index:9999; pointer-events:none;
            border-radius:10px; border:1px solid rgba(255,255,255,.15);
            box-shadow:0 12px 36px rgba(0,0,0,.6);
            background:rgba(10,10,14,.96); padding:6px; opacity:0; transition:opacity .12s ease;
            /*max-width:min(40vw,520px); max-height:min(70vh,520px); overflow:hidden;*/
            /* no cropping */
            max-width: 60vw; max-height: 60vh; overflow: visible;
        }
        .img-tooltip img{display:block;width:auto;height:auto;max-width:60vw;max-height:60vh;object-fit:contain}
        #artist-filter label{color:var(--ink)}
        .tooltip-text {
            background: rgba(20, 20, 30, 0.6);   /* dark translucent background */
            backdrop-filter: blur(8px);          /* frosted glass blur */
            -webkit-backdrop-filter: blur(8px);  /* Safari support */

            color: #fff;                          /* white text for contrast */
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
            line-height: 1.4;
            max-width: 260px;
        }
        main.content-wide {
            margin: 20px;
        }
    </style>
</head>

<body>
<header class="site-header">
    <nav class="nav">
        <a href="../../index.html">Home</a>
        <a href="about.html">About</a>
        <a href="connections.html" aria-current="page">Art Connections</a>
        <a href="filters.html">Art Filters</a>
    </nav>
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">‚ò∞</button>
</header>

<main class="content-wide">
    <h1 class="page-title">Art Visualized</h1>

    <button id="resetFilters">Reset All Filters</button>

    <div id="filters" style="display:flex; gap:1rem; flex-wrap:wrap; margin:1rem 0;">
        <div id="artist-filter">
            <label for="artistSelect" style="margin-right:.5rem;">Select Artist:</label>
            <select id="artistSelect" style="padding:.3rem;font-size:1rem; width:200px;">
                <option value="all">All Artists</option>
            </select>
        </div>

        <div id="artwork-filter">
            <label for="artworkSelect" style="margin-right:.5rem;">Select Artwork:</label>
            <select id="artworkSelect" style="padding:.3rem;font-size:1rem; width:200px;">
                <option value="">-- All Artworks --</option>
            </select>
        </div>

        <div id="medium-filter">
            <label for="mediumSelect" style="margin-right:.5rem;">Select Medium:</label>
            <select id="mediumSelect" style="padding:.3rem;font-size:1rem; width:200px;">
                <option value="">-- All Mediums --</option>
            </select>
        </div>

        <div id="nationality-filter">
            <label for="nationalitySelect" style="margin-right:.5rem;">Select Artist Nationality:</label>
            <select id="nationalitySelect" style="padding:.3rem;font-size:1rem; width:200px;">
                <option value="">-- All Nationalities --</option>
            </select>
        </div>

        <div id="date-filter">
            <label for="dateSelect" style="margin-right:.5rem;">Select Period:</label>
            <select id="dateSelect" style="padding:.3rem;font-size:1rem; width:200px;">
                <option value="">-- All Periods --</option>
            </select>
        </div>
    </div>

    <section class="viz-wrapper">
        <header class="viz-header">
            <h2 style="margin:0;font-size:1.1rem;color:var(--ink);font-weight:600;">Similarity Graph of Artworks</h2>

            <!-- Usage Tip -->
            <div id="usage-tip" style="
                margin:.5rem 0; 
                background: rgba(30,30,40,0.85); 
                padding:12px; 
                border-radius:8px; 
                color:white;
                line-height:1.5;
                transition: all 0.5s ease;
            ">
                You can explore the similarity graph of artworks using the filters below. Each filter helps you narrow down the artworks displayed:<br><br>

                üñåÔ∏è <strong>Artist:</strong> Choose a specific artist to see only their works and connections with others.<br>
                üñºÔ∏è <strong>Artwork:</strong> Select a particular artwork to highlight its relationships with similar pieces.<br>
                üß∞ <strong>Medium:</strong> Filter by the medium used (e.g., oil, watercolor, sculpture) to focus on specific types of artworks.<br>
                üåç <strong>Artist Nationality:</strong> Explore works by artists from a particular country or region.<br>
                üìÖ <strong>Period / Year:</strong> Limit the display to artworks from a certain time period.<br><br>

                <strong>Tips:</strong><br>
                ‚Ä¢ You can use multiple filters at once to refine your search.<br>
                ‚Ä¢ The graph shows each artwork as a thumbnail; more connected artworks appear larger.<br>
                ‚Ä¢ Hover over an artwork to see a larger preview and detailed information like title, artist, year, medium, and nationality.<br>
                ‚Ä¢ Drag artworks around to explore their connections.<br>
                ‚Ä¢ Click ‚ÄúReset All Filters‚Äù to clear all selections and start fresh.
            </div>
        </header>

        <div id="viz-root"></div>
    </section>
</main>

<script src="../scripts/main.js" defer></script>
<script src="../lib/d3.v5.min.js"></script>
<script src="../lib/d3-dsv.min.js"></script>

<script>
    (function () {

        //  Global variable to keep track of currently filtered data
        let currentFiltered = [];
        /*  Setting up our images directory and thumbnails directory
            Using Google Cloud Storage link or grabbing the images locally */
        var ON_GCS   = location.hostname === "storage.googleapis.com";
        var GCS_BASE = "https://storage.googleapis.com/visualizing-art";
        var IMAGES_DIR     = ON_GCS ? (GCS_BASE + "/images")     : "../../images";
        var THUMBNAILS_DIR = ON_GCS ? (GCS_BASE + "/thumbnails") : "../../thumbnails";

        function fullImageURL(id){
            id = String(id || "").trim();
            return id ? (IMAGES_DIR + "/" + id + ".jpg") : undefined;
        }
        function thumbURL(id){
            id = String(id || "").trim();
            return id ? (THUMBNAILS_DIR + "/" + id + ".jpg") : undefined;
        }

        /* Grabbing the information from the CSV file */
        d3.dsv(",", "../../embeddings/summary_cross_artist_with_metadata.csv", function (d) {
            return {
                source: d.query_object_id,
                target: d.similar_object_id,
                value: +d.similarity_score,

                query_title: d.query_title,
                similar_title: d.similar_title,

                query_artist:  d.query_artist,
                similar_artist:d.similar_artist,


                query_medium: d.query_medium,
                similar_medium: d.similar_medium,

                query_artist_nationality: d.query_artist_nationality,
                similar_artist_nationality: d.similar_artist_nationality,

                query_object_begin_date: d.query_object_begin_date,
                similar_object_begin_date: d.similar_object_begin_date
            };
        }).then(function(rawLinks){

            // Building the artist list for the dropdown
            const dropdown = d3.select("#artistSelect");
            dropdown.selectAll("*").remove();
            dropdown.append("option")
                .attr("value", "")
                .text("-- Select an Artist --");

            const artists = Array.from(new Set(
                rawLinks.flatMap(l => [l.query_artist, l.similar_artist]).filter(Boolean)
            )).sort();

            artists.forEach(a => dropdown.append("option").attr("value", a).text(a));

            // Precompute all artworks by artist for faster artwork dropdown updates
            const artworkByArtist = {};
            artists.forEach(artist => {
                const fromQuery = rawLinks
                    .filter(l => (l.query_artist || "").trim() === artist.trim())
                    .map(l => l.query_title);
                const fromSimilar = rawLinks
                    .filter(l => (l.similar_artist || "").trim() === artist.trim())
                    .map(l => l.similar_title);
                artworkByArtist[artist] = Array.from(new Set(fromQuery.concat(fromSimilar).filter(Boolean))).sort();
            });


            // --- Populate Medium Dropdown ---
            const mediumDropdown = d3.select("#mediumSelect");
            const mediums = Array.from(new Set(
                rawLinks.flatMap(l => [l.query_medium, l.similar_medium]).filter(Boolean)
            )).sort();
            mediums.forEach(m => mediumDropdown.append("option").attr("value", m).text(m));

            // --- Populate Artist Nationality Dropdown ---
            const nationalityDropdown = d3.select("#nationalitySelect");
            const nationalities = Array.from(new Set(
                rawLinks.flatMap(l => [l.query_artist_nationality, l.similar_artist_nationality]).filter(Boolean)
            )).sort();
            nationalities.forEach(n => nationalityDropdown.append("option").attr("value", n).text(n));

            // --- Populate Date / Period Dropdown ---
            const dateDropdown = d3.select("#dateSelect");
            const dates = Array.from(new Set(
                rawLinks.flatMap(l => [l.query_object_begin_date, l.similar_object_begin_date])
                    .filter(Boolean)
            )).sort((a,b) => a-b);
            dates.forEach(d => dateDropdown.append("option").attr("value", d).text(d));

            //  Initially full dataset
            allData = rawLinks;

            // Initially, dropdowns show all options
            updateDropdowns(allData);

            // Do NOT render graph yet to avoid freezing
            currentFiltered = [];  // nothing rendered until user selects a filter


            //  Update dropdowns

            function updateDropdowns(filtered) {
                // Keep currently selected values
                const currentArtwork = d3.select("#artworkSelect").property("value");
                const currentMedium = d3.select("#mediumSelect").property("value");
                const currentNationality = d3.select("#nationalitySelect").property("value");
                const currentDate = d3.select("#dateSelect").property("value");

                // --- Artist ---
                const artistDropdown = d3.select("#artistSelect");
                const currentArtist = artistDropdown.property("value");
                const artists = Array.from(new Set(
                    filtered.flatMap(l => [l.query_artist, l.similar_artist]).filter(Boolean)
                )).sort();

                artistDropdown.selectAll("option").remove();
                artistDropdown.append("option").attr("value", "").text("-- Select an Artist --");
                artists.forEach(a => artistDropdown.append("option").attr("value", a).text(a));

                // Keep the same artist selected if it still exists
                if (artists.includes(currentArtist)) {
                    artistDropdown.property("value", currentArtist);
                } else {
                    artistDropdown.property("value", "");
                }

                // --- Artwork ---
                const artworkDropdown = d3.select("#artworkSelect");

                // Faster artwork filtering using precomputed mapping
                let artworks;
                if (currentArtist && artworkByArtist[currentArtist]) {
                    artworks = artworkByArtist[currentArtist];
                } else {
                    artworks = Array.from(new Set(
                        filtered.flatMap(l => [l.query_title, l.similar_title]).filter(Boolean)
                    )).sort();
                }

                artworkDropdown.selectAll("option").remove();
                artworkDropdown.append("option").attr("value", "").text("-- All Artworks --");
                artworks.forEach(a => artworkDropdown.append("option").attr("value", a).text(a));
                if (artworks.includes(currentArtwork)) artworkDropdown.property("value", currentArtwork);

                // --- Medium ---
                const mediumDropdown = d3.select("#mediumSelect");
                const mediums = Array.from(new Set(
                    filtered.flatMap(l => [l.query_medium, l.similar_medium]).filter(Boolean)
                )).sort();
                mediumDropdown.selectAll("option").remove();
                mediumDropdown.append("option").attr("value", "").text("-- All Mediums --");
                mediums.forEach(m => mediumDropdown.append("option").attr("value", m).text(m));
                if (mediums.includes(currentMedium)) mediumDropdown.property("value", currentMedium);

                // --- Nationality ---
                const nationalityDropdown = d3.select("#nationalitySelect");
                const nationalities = Array.from(new Set(
                    filtered.flatMap(l => [l.query_artist_nationality, l.similar_artist_nationality]).filter(Boolean)
                )).sort();
                nationalityDropdown.selectAll("option").remove();
                nationalityDropdown.append("option").attr("value", "").text("-- All Nationalities --");
                nationalities.forEach(n => nationalityDropdown.append("option").attr("value", n).text(n));
                if (nationalities.includes(currentNationality)) nationalityDropdown.property("value", currentNationality);

                // --- Date ---
                const dateDropdown = d3.select("#dateSelect");
                const dates = Array.from(new Set(
                    filtered.flatMap(l => [l.query_object_begin_date, l.similar_object_begin_date]).filter(Boolean)
                )).sort((a, b) => a - b);
                dateDropdown.selectAll("option").remove();
                dateDropdown.append("option").attr("value", "").text("-- All Periods --");
                dates.forEach(d => dateDropdown.append("option").attr("value", d).text(d));
                if (dates.includes(currentDate)) dateDropdown.property("value", currentDate);
            }



            function filterData() {
                const artist = d3.select("#artistSelect").property("value");
                const artwork = d3.select("#artworkSelect").property("value");
                const medium = d3.select("#mediumSelect").property("value");
                const nationality = d3.select("#nationalitySelect").property("value");
                const date = d3.select("#dateSelect").property("value");

                let filtered = allData;


                if (artist) {
                    filtered = filtered.filter(l =>
                        (l.query_artist || "").trim() === artist.trim() ||
                        (l.similar_artist || "").trim() === artist.trim()
                    );
                }

                if (artwork) {
                    filtered = filtered.filter(l =>
                        l.query_title === artwork || l.similar_title === artwork
                    );
                }

                if (medium) {
                    filtered = filtered.filter(l =>
                        (l.query_medium || "").trim() === medium.trim() ||
                        (l.similar_medium || "").trim() === medium.trim()
                    );
                }

                if (nationality) {
                    filtered = filtered.filter(l =>
                        (l.query_artist_nationality || "").trim() === nationality.trim() ||
                        (l.similar_artist_nationality || "").trim() === nationality.trim()
                    );
                }

                if (date) {
                    filtered = filtered.filter(l =>
                        (l.query_object_begin_date || "") === date ||
                        (l.similar_object_begin_date || "") === date
                    );
                }

                // Update all other dropdowns based on currently filtered data
                updateDropdowns(filtered);

                // Save the filtered dataset globally for next filtering
                currentFiltered = filtered;

                // Avoid freezing: limit to 300 links
                const MAX_LINKS = 300;
                if (filtered.length > MAX_LINKS) {
                    filtered = filtered.slice(0, MAX_LINKS)
                    console.warn("Too many links, showing only first ${MAX_LINKS} to prevent freezing.");
                }


                d3.select("#viz-root").selectAll("*").remove();
                renderGraph(filtered);
            }

            d3.select("#artistSelect").on("change", filterData);
            d3.select("#artworkSelect").on("change", filterData);
            d3.select("#mediumSelect").on("change", filterData);
            d3.select("#nationalitySelect").on("change", filterData);
            d3.select("#dateSelect").on("change", filterData);

            // --- Usage Tip Logic ---
            const usageTip = d3.select("#usage-tip");

            function hideUsageTip() {
                usageTip.transition().duration(500)
                    .style("opacity", 0)
                    .style("height", 0)
                    .style("padding", 0)
                    .style("margin", 0);

                // Remove this event so it only triggers once
                d3.selectAll("#artistSelect, #artworkSelect, #mediumSelect, #nationalitySelect, #dateSelect")
                    .on("change.usageTip", null);
            }

            // Hide tip on first filter change
            d3.selectAll("#artistSelect, #artworkSelect, #mediumSelect, #nationalitySelect, #dateSelect")
                .on("change.usageTip", hideUsageTip);

            d3.select("#resetFilters").on("click", function() {
                // Clear all dropdowns
                d3.select("#artistSelect").property("value", "");
                d3.select("#artworkSelect").property("value", "");
                d3.select("#mediumSelect").property("value", "");
                d3.select("#nationalitySelect").property("value", "");
                d3.select("#dateSelect").property("value", "");

                // Repopulate dropdown options
                updateDropdowns(allData);

                // Clear visualization
                d3.select("#viz-root").selectAll("*").remove();

                // Reset filtered data tracker
                currentFiltered = [];

                // Show usage tip again
                usageTip.transition().duration(500)
                    .style("opacity", 1)
                    .style("height", "auto")
                    .style("padding", "12px")
                    .style("margin", ".5rem 0");

                // Reattach the one-time hide event
                d3.selectAll("#artistSelect, #artworkSelect, #mediumSelect, #nationalitySelect, #dateSelect")
                    .on("change.usageTip", hideUsageTip);

                console.log("Filters reset ‚Äî usage tip shown again.");
            });



            // Rendering the graph
            function renderGraph(linksRaw){

                // Merging the endpoints to the nodes
                const nodesByTitle = {};
                linksRaw.forEach(l => {
                    if (!nodesByTitle[l.source]) {
                        nodesByTitle[l.source] = {
                            key: l.source,
                            id: l.source,
                            name: l.query_title || "",
                            degree: 0,
                            artist: l.query_artist || "Unknown",
                            medium: l.query_medium || "",
                            year: l.query_object_begin_date || "",
                            nationality: l.query_artist_nationality || ""
                        };
                    } /*else {
                        if (!nodesByTitle[l.source].id && l.query_id) nodesByTitle[l.source].id = l.query_id;
                    }*/
                    if (!nodesByTitle[l.target]) {
                        nodesByTitle[l.target] = {
                            key: l.target,
                            id: l.target,
                            name: l.similar_title || "",
                            degree: 0,
                            artist: l.similar_artist || "Unknown",
                            medium: l.similar_medium || "",
                            year: l.similar_object_begin_date || "",
                            nationality: l.similar_artist_nationality || ""
                        };
                    } /*else {
                        if (!nodesByTitle[l.target].id && l.similar_id) nodesByTitle[l.target].id = l.similar_id;
                    }*/
                });
                linksRaw.forEach(l => { nodesByTitle[l.source].degree++; nodesByTitle[l.target].degree++; });

                const nodes = Object.values(nodesByTitle);
                const byKey = {}; nodes.forEach(n => byKey[n.key] = n);

                const links = linksRaw.map(l => {
                    const s = byKey[l.source], t = byKey[l.target];
                    return (s && t) ? { source:s, target:t, value:l.value } : null;
                }).filter(Boolean);

                // SVG and simulation
                const wrap = document.getElementById("viz-root");
                function dims(){ const r = wrap.getBoundingClientRect(); return { w:r.width||800, h:Math.max(window.innerHeight*0.7, 500) }; }
                let {w:width, h:height} = dims();

                const svg = d3.select("#viz-root").append("svg")
                    .attr("xmlns:xlink","http://www.w3.org/1999/xlink")
                    .attr("width", width).attr("height", height).style("display","block").style("max-width","100%");

                const path = svg.append("g").selectAll("path").data(links).enter().append("path")
                    .style("fill","none")
                    .style("stroke", d => d.value===0 ? "gray" : "green")
                    .style("stroke-width", d => d.value===0 ? 3 : 1.5)
                    .style("stroke-dasharray", d => d.value===0 ? null : "4,2");

                // Size of artworks (nodes) are based on degree (number of connections)
                const extent = d3.extent(nodes, d => d.degree);
                if (extent[0] === extent[1]) extent[0] -= 1;

                const MIN_NODE_PX = 64;
                const MAX_NODE_PX = 140;
                const rScale = d3.scaleSqrt().domain(extent).range([MIN_NODE_PX, MAX_NODE_PX]);
                nodes.forEach(n => { if (n.degree <= 1) n.degree = 2; });

                // Updated more smooth force simulation
                const sim = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.key).distance(200).strength(0.3))
                    .force("charge", d3.forceManyBody().strength(-160))
                    .force("center", d3.forceCenter(width/2, height/2))
                    .force("collision", d3.forceCollide().radius(d => rScale(d.degree) / 1.6))
                    .alphaDecay(0.05)
                    .on("tick", tick);

                window.addEventListener("resize", () => {
                    ({w:width, h:height} = dims());
                    svg.attr("width", width).attr("height", height);
                    sim.force("center", d3.forceCenter(width/2, height/2))
                        .force("x", d3.forceX(width/2))
                        .force("y", d3.forceY(height/2))
                        .alphaTarget(0.4).restart();
                });

                // Creating the tooltip that will show the full image when hovered
                const tooltip = document.body.appendChild(document.createElement("div"));
                tooltip.className = "img-tooltip";
                const tipImg = tooltip.appendChild(document.createElement("img"));

                // Container for metadata
                const tipInfo = tooltip.appendChild(document.createElement("div"));
                tipInfo.style.color = "white";
                tipInfo.style.marginTop = "6px";
                tipInfo.style.fontSize = "0.85rem";
                tipInfo.style.fontFamily = "sans-serif";

                function showTip(d){
                    const u = fullImageURL(d.id);
                    if (!u) return;

                    tipImg.src = u;
                    tooltip.style.opacity = "1";

                    // Add metadata
                    tipInfo.innerHTML = `
                        <div class="tooltip-text">
                            <div><strong>${d.name}</strong></div>
                            <div>${d.artist || ""}</div>
                            <div>${d.year || ""}</div>
                            <div>${d.medium || ""}</div>
                            <div>${d.nationality || ""}</div>
                        </div>
                    `;

                }

                function moveTip(ev){
                    const PAD=12, GAP=14, vw=window.innerWidth||document.documentElement.clientWidth, vh=window.innerHeight||document.documentElement.clientHeight;
                    const rect=tooltip.getBoundingClientRect(), tw=rect.width||300, th=rect.height||200;
                    let x=ev.clientX+GAP, y=ev.clientY+GAP;
                    if (x+tw+PAD>vw) x=Math.max(PAD, ev.clientX-GAP-tw);
                    if (y+th+PAD>vh) y=Math.max(PAD, ev.clientY-GAP-th);
                    x=Math.max(PAD, Math.min(vw-tw-PAD, x));
                    y=Math.max(PAD, Math.min(vh-th-PAD, y));
                    tooltip.style.left=x+"px"; tooltip.style.top=y+"px";
                }
                function hideTip(){ tooltip.style.opacity="0"; tipImg.removeAttribute("src"); }

                const node = svg.selectAll(".node").data(nodes).enter().append("g").attr("class","node")
                    .call(d3.drag().on("start", dragStart).on("drag", dragged).on("end", dragEnd))
                    .on("mouseenter", d => showTip(d))
                    .on("mousemove", () => moveTip(d3.event))
                    .on("mouseleave", () => hideTip());

                // keep a drag target even if image missing
                node.append("circle").attr("class","drag-handle")
                    .attr("r", d => Math.max(12, rScale(d.degree)/2));

                // thumbnail image (from /thumbnails/)
                node.append("image").each(function(d){
                    const href = thumbURL(d.id);
                    const s = rScale(d.degree);
                    const el = d3.select(this);
                    el.attr("width", s).attr("height", s).attr("x",-s/2).attr("y",-s/2);
                    // <<< NEW >>> Use requestAnimationFrame instead of setTimeout for batch updates
                    if (!href) return;
                    requestAnimationFrame(() => el.attr("href", href).attr("xlink:href", href));
                });

                // title label (above)
                node.append("text")
                    .attr("dy", d => -rScale(d.degree)/2 - 2)
                    .attr("text-anchor","middle")
                    .style("font-weight","bold")
                    .text(d => d.name);

                // artist label (below)
                node.append("text")
                    .attr("dy", d => rScale(d.degree)/2 + 12)
                    .attr("text-anchor","middle")
                    .style("font-style","italic")
                    .text(d => (d.artist && d.artist.trim()) ? d.artist : "Unknown");

                // credit
                svg.append("text").attr("x", width-20).attr("y", height-20).attr("text-anchor","end")
                    .style("font-size","14px").style("fill","var(--muted)")
                    .text("Visualizing Art ‚Äî Similarity Graph");

                function tick(){
                    path.attr("d", d => {
                        d.source.x = Math.max(30, Math.min(width-30, d.source.x));
                        d.source.y = Math.max(30, Math.min(height-30, d.source.y));
                        d.target.x = Math.max(30, Math.min(width-30, d.target.x));
                        d.target.y = Math.max(30, Math.min(height-30, d.target.y));
                        const dx=d.target.x-d.source.x, dy=d.target.y-d.source.y, dr=Math.sqrt(dx*dx+dy*dy);
                        return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                    });
                    node.attr("transform", d => {
                        d.x = Math.max(30, Math.min(width-30, d.x));
                        d.y = Math.max(30, Math.min(height-30, d.y));
                        return `translate(${d.x},${d.y})`;
                    });
                }
                function dragStart(d){ if(!d3.event.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
                function dragged(d){ d.fx=d3.event.x; d.fy=d3.event.y; }
                function dragEnd(d){ if(!d3.event.active) sim.alphaTarget(0); /* keep final position */ }
            }
        }).catch(err => console.error("Error loading or rendering CSV:", err));
    })();
</script>
</body>
</html>
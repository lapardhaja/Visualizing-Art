<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../styles/main.css" />
    <title>Art Filters - Visualizing Art</title>
    <!-- Importing our D3 -->
    <script src="../lib/d3.v5.min.js"></script>

    <style>
        /* Cleaning up the layout of page */
        .page-wrapper {
            max-width: 1280px;
            margin: 0 auto;
            padding: 40px 32px 80px;
        }
        .filters-subtitle{
            color: var(--muted,#9ca3af);
            font-size: 0.95rem;
            margin-bottom: 1.75rem;
        }
        .filters-row{
            display:grid;
            grid-template-columns: repeat(4,minmax(0,1fr));
            gap:16px;
        }
        .field-group{ display:flex; flex-direction:column; gap:4px; }
        .field-label{ font-size:0.85rem; color:var(--muted,#9ca3af); }

        /* Adding some aesthetically pleasing dropdowns */
        .field-select{
            min-width: 220px;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.85);
            color: #e5e7eb;
        }
        .filters-buttons{ display:flex; gap:8px; flex-wrap:wrap; }

        /* Cleaning up the buttons */
        .btn-small{
            padding: 6px 14px;
            font-size: 14px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
        }

        /* Adding different color to the primary Submition button */
        .btn-primary{
            background:#22c55e;
            color:#020617;
        }

        /* Adding different color to the secondary buttons */
        .btn-secondary{
            background:#0f172a;
            color:#e5e7eb;
            border:1px solid rgba(148,163,184,0.5);
        }

        /* Cleaning up the UI */
        .layout-main{
            display:grid;
            grid-template-columns: minmax(260px,320px) minmax(0,1fr);
            gap:20px;
            margin-top:20px;
        }

        /* Adding some borders to represent the separation between chosen artwork and results */
        .card{
            border-radius:12px;
            background:radial-gradient(circle at top left,rgba(148,163,184,0.12),rgba(15,23,42,0.94));
            border:1px dashed rgba(148,163,184,0.35);
            padding:16px 18px;
            color:#e5e7eb;
        }
        .card-heading{
            font-weight:600;
            margin-bottom:8px;
        }

        /* Making multiple modifications to the display of the Chosen artwork (for UI cleanliness) */
        .chosen-artwork{ display:flex; flex-direction:column; gap:10px; }
        .chosen-img-wrap{
            width:100%;
            aspect-ratio:4/5;
            border-radius:12px;
            overflow:hidden;
            background:#020617;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .chosen-img-wrap img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .chosen-meta-line{
            font-size:13px;
            margin-bottom:2px;
        }
        .chosen-meta-label{
            color:var(--muted,#9ca3af);
        }

        /* Making multiple modifications to the display of the Results (for UI cleanliness) */
        .results-header{
            display:flex;
            justify-content:space-between;
            align-items:baseline;
            margin-bottom:10px;
        }
        .results-grid{
            display:grid;
            grid-template-columns:repeat(5,minmax(0,1fr));
            gap:14px;
        }
        .result-card{
            border-radius:12px;
            background:rgba(15,23,42,0.95);
            border:1px solid rgba(148,163,184,0.35);
            padding:10px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        .result-img-wrap{
            width:100%;
            aspect-ratio:4/5;
            border-radius:10px;
            overflow:hidden;
            background:#020617;
        }
        .result-img-wrap img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        .result-meta{ margin-top:4px; }
        .result-meta-line{
            font-size:11px;
            margin-bottom:2px;
        }
        .result-meta-label{
            color:var(--muted,#9ca3af);
        }

        .badge{
            font-size:0.75rem;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.7);
            color:var(--muted,#9ca3af);
        }

        /* Used for when there are no results being shown */
        .hidden{
            display:none !important;
        }

    </style>
</head>
<body>
<header class="site-header">
    <nav class="nav">
        <a href="../../index.html">Home</a>
        <a href="about.html">About</a>
        <a href="connections.html">Art Connections</a>
        <a href="filters.html" aria-current="page">Art Filters</a>
    </nav>
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">☰</button>
</header>

<main class="page-wrapper">
    <h1 class="page-title">Art Filters</h1>
    <p class="filters-subtitle">
        First, pick an artist.
        Next, choose one of their artworks.
        Last, apply a filter to browse similarities between artworks!
    </p>

    <div class="filters-row">
        <div class="field-group">
            <label class="field-label" for="artistSelect">Choose an Artist</label>
            <select id="artistSelect" class="field-select">
                <option value="">— Select an artist —</option>
            </select>
        </div>

        <!-- Filtration controls and buttons -->
        <div class="field-group">
            <label class="field-label" for="artworkSelect">Choose an Artwork</label>
            <select id="artworkSelect" class="field-select" disabled>
                <option value="">— Select an artwork —</option>
            </select>
        </div>

        <div class="field-group">
            <label class="field-label" for="filterSelect">Choose a Filter</label>
            <select id="filterSelect" class="field-select" disabled>
                <option value="most-similar">Most Similar</option>
                <option value="most-similar-diff-artist">Most Similar (different artist)</option>
                <option value="most-similar-diff-date">Most Similar (different date)</option>
            </select>
        </div>

        <div class="field-group">
            <span class="field-label">&nbsp;</span>
            <div class="filters-buttons">
                <button id="btnSubmit" class="btn-small btn-primary" disabled>Show Results</button>
                <button id="btnRandom" class="btn-small btn-secondary">Random</button>
                <button id="btnReset" class="btn-small btn-secondary">Reset</button>
            </div>
        </div>
    </div>

    <!-- Layout of the displayed artworks -->
    <div class="layout-main">
        <!-- Chosen artworks on the left side -->
        <section id="chosenPanel" class="card chosen-artwork">
            <div class="card-heading">Chosen artwork</div>
            <div class="chosen-img-wrap">
                <span style="font-size:12px;color:var(--muted,#9ca3af);text-align:center;padding:0 12px;">
                    Pick an artist, then an artwork to see its details here.
                </span>
            </div>
            <div id="chosenMeta">
                <!-- This will be populated dynamically (after user chooses artist and artwork) -->
            </div>
        </section>

        <!-- Resulting artworks on the right side -->
        <section id="resultsPanel" class="card">
            <div class="results-header">
                <div class="card-heading">Results</div>
                <div id="resultsRuleLabel" class="badge hidden"></div>
            </div>
            <div id="resultsEmpty">
                No results yet. Choose all three filters and press <strong>Show Results</strong>,
                or try <strong>Random</strong> to explore a variety of artworks.
            </div>
            <div id="resultsGrid" class="results-grid hidden"></div>
        </section>
    </div>
</main>

<script>
    (function () {
        // Setting up our similarity csv file
        const CSV_PATH = "../../embeddings/summary_combined.csv";

        // Grabbing all the HTML elements we need, so it's easier to reference them later
        const artistSelect      = document.getElementById("artistSelect");
        const artworkSelect     = document.getElementById("artworkSelect");
        const filterSelect      = document.getElementById("filterSelect");
        const btnSubmit         = document.getElementById("btnSubmit");
        const btnRandom         = document.getElementById("btnRandom");
        const btnReset          = document.getElementById("btnReset");
        const chosenPanel       = document.getElementById("chosenPanel");
        const chosenMeta        = document.getElementById("chosenMeta");
        const resultsGrid       = document.getElementById("resultsGrid");
        const resultsEmpty      = document.getElementById("resultsEmpty");
        const resultsRuleLabel  = document.getElementById("resultsRuleLabel");

        // Setting up some var's that will be filled once the CSV loads
        let edges = [];
        let artworkIndex = {};
        let artistIndex  = {};

        // Function that helps safely trim text, even if the value is null/undefined
        function safeTrim(v) {
            return (v === undefined || v === null) ? "" : String(v).trim();
        }

        // Converting one CSV row into a cleaner object with the fields we need for our page
        function parseRow(d) {
            return {
                aId:     safeTrim(d.query_object_id),
                bId:     safeTrim(d.similar_object_id),
                aTitle:  safeTrim(d.query_title),
                bTitle:  safeTrim(d.similar_title),
                aArtist: safeTrim(d.query_artist),
                bArtist: safeTrim(d.similar_artist),
                aMedium: safeTrim(d.query_medium),
                bMedium: safeTrim(d.similar_medium),
                aEnd:    safeTrim(d.query_object_end_date),
                bEnd:    safeTrim(d.similar_object_end_date),
                similarity: +d.similarity_score || 0
            };
        }

        // Creating some quick data structures
        // This will help us find artworks and edges faster
        function buildIndexes(rows) {
            // Internal data structures (similarity scoring, art titles, and artist names)
            edges = [];
            artworkIndex = {};
            artistIndex = {};

            rows.forEach(r => {
                if (!r.aId || !r.bId) return;

                // Normalizing missing artist names to "Unknown"
                // Without this, a good chunk of our dataset would not show up
                r.aArtist = r.aArtist || "Unknown";
                r.bArtist = r.bArtist || "Unknown";

                // Storing the edge
                edges.push(r);

                // Indexing the specific artworks
                function indexArtwork(id, title, artist, medium, end) {
                    if (!id) return;

                    if (!artworkIndex[id]) {
                        artworkIndex[id] = {
                            id,
                            title,
                            artist,
                            medium,
                            end
                        };
                    }

                    const artistKey = artist || "Unknown";
                    if (!artistIndex[artistKey]) artistIndex[artistKey] = [];
                    if (!artistIndex[artistKey].includes(id)) {
                        artistIndex[artistKey].push(id);
                    }
                }

                indexArtwork(r.aId, r.aTitle, r.aArtist, r.aMedium, r.aEnd);
                indexArtwork(r.bId, r.bTitle, r.bArtist, r.bMedium, r.bEnd);
            });
        }

        // Function that will populate the artist names into our first dropdown
        // This should be showing all artists in our dataset
        function populateArtists() {
            const artists = Object.keys(artistIndex).sort();
            artistSelect.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "— Select an artist —";
            artistSelect.appendChild(opt);

            artists.forEach(a => {
                const o = document.createElement("option");
                o.value = a;
                o.textContent = a;
                artistSelect.appendChild(o);
            });
        }

        // This function will then populate the artworks for the chosen artist
        // The user must choose and artist first
        function populateArtworksForArtist(artist) {
            artworkSelect.innerHTML = "";
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "— Select an artwork —";
            artworkSelect.appendChild(opt);

            if (!artist || !artistIndex[artist]) return;

            const ids = artistIndex[artist].slice().sort();
            ids.forEach(id => {
                const meta = artworkIndex[id];
                if (!meta) return;
                const o = document.createElement("option");
                // value is the object ID so identical titles are separate
                o.value = id;
                o.textContent = meta.title || `Artwork ${id}`;
                artworkSelect.appendChild(o);
            });
        }

        // Function to grab respective image using the object ID
        function fullImageURL(id) {
            if (!id) return null;
            return "../../images/" + id + ".jpg";
        }

        // Rendering the chosen image and its respective metadata information
        function renderchosen(artworkId) {
            const meta = artworkIndex[artworkId];
            const imgWrap = chosenPanel.querySelector(".chosen-img-wrap");
            imgWrap.innerHTML = "";
            const img = document.createElement("img");

            if (meta && meta.id) {
                img.src = fullImageURL(meta.id);
                img.alt = meta.title || "Artwork";
            } else {
                img.alt = "Artwork";
            }
            imgWrap.appendChild(img);

            chosenMeta.innerHTML = "";
            if (!meta) {
                const p = document.createElement("p");
                p.className = "chosen-meta-line";
                p.textContent = "No metadata found for this artwork.";
                chosenMeta.appendChild(p);
                return;
            }

            function line(label, value) {
                const p = document.createElement("p");
                p.className = "chosen-meta-line";
                p.innerHTML =
                    `<span class="chosen-meta-label">${label}:</span> ${value || "Unknown"}`;
                chosenMeta.appendChild(p);
            }

            line("Title",  meta.title);
            line("Artist", meta.artist);
            line("Medium", meta.medium);
            line("Date",   meta.end);
        }

        // Function that will find and return the artworks that match our certain filters
        function computeResults(artist, artworkId, rule) {
            if (!artist || !artworkId) return [];

            const chosenMeta = artworkIndex[artworkId] || {};
            const chosenEnd  = safeTrim(chosenMeta.end);
            const chosenArtist = artist || "Unknown";

            const neighbors = [];

            // Only use rows where this artwork appears as the QUERY (aId)
            edges.forEach(e => {
                if (e.aId === artworkId) {
                    neighbors.push({
                        id: e.bId,
                        title: e.bTitle,
                        artist: e.bArtist || "Unknown",
                        medium: e.bMedium,
                        end: e.bEnd,
                        similarity: e.similarity
                    });
                }
            });

            // Deduplicate by object ID, keeping the highest similarity per ID
            const byId = new Map();
            neighbors.forEach(n => {
                if (!n.id) return;
                const existing = byId.get(n.id);
                if (!existing || n.similarity > existing.similarity) {
                    byId.set(n.id, n);
                }
            });

            let list = Array.from(byId.values());

            if (rule === "most-similar-diff-artist") {
                list = list.filter(n =>
                    safeTrim(n.artist) &&
                    safeTrim(n.artist) !== safeTrim(chosenArtist)
                );
            } else if (rule === "most-similar-diff-date") {
                list = list.filter(n =>
                    safeTrim(n.end) &&
                    safeTrim(n.end) !== chosenEnd
                );
            }

            list.sort((a, b) => b.similarity - a.similarity);

            // Each row in the CSV is already "primary" for this query,
            // so we just take the first few (often up to 5).
            return list.slice(0, 10);
        }

        // Rendering the results (artworks and respective metadata)
        function renderResults(results) {
            resultsGrid.innerHTML = "";
            if (!results || results.length === 0) {
                resultsGrid.classList.add("hidden");
                resultsEmpty.classList.remove("hidden");
                return;
            }

            resultsEmpty.classList.add("hidden");
            resultsGrid.classList.remove("hidden");

            results.forEach(r => {
                const card = document.createElement("div");
                card.className = "result-card";

                const imgWrap = document.createElement("div");
                imgWrap.className = "result-img-wrap";
                const img = document.createElement("img");
                if (r.id) img.src = fullImageURL(r.id);
                img.alt = r.title || "Artwork";
                imgWrap.appendChild(img);
                card.appendChild(imgWrap);

                // Setting up our "Text block" for the chosen artwork:
                // Title, Artist, Medium, Date
                const metaBlock = document.createElement("div");
                metaBlock.className = "result-meta";

                function line(label, value) {
                    const p = document.createElement("div");
                    p.className = "result-meta-line";
                    p.innerHTML =
                        `<span class="result-meta-label">${label}:</span> ${value || "Unknown"}`;
                    metaBlock.appendChild(p);
                }

                line("Title",  r.title);
                line("Artist", r.artist);
                line("Medium", r.medium);
                line("Date",   r.end);

                card.appendChild(metaBlock);
                resultsGrid.appendChild(card);
            });
        }

        // Function that will update label so we are filtering properly and showing the correct results
        function updateRuleLabel(rule) {
            let text = "";
            if (rule === "most-similar") text = "Most Similar";
            else if (rule === "most-similar-diff-artist") text = "Most Similar — different artist";
            else if (rule === "most-similar-diff-date") text = "Most Similar — different date";

            if (!text) {
                resultsRuleLabel.classList.add("hidden");
            } else {
                resultsRuleLabel.textContent = text;
                resultsRuleLabel.classList.remove("hidden");
            }
        }

        // When the user picks an artist, we only display the artworks from that artist in the next dropdown
        artistSelect.addEventListener("change", () => {
            const artist = artistSelect.value;
            populateArtworksForArtist(artist);
            artworkSelect.disabled = !artist;
            filterSelect.disabled = true;
            btnSubmit.disabled = true;

            chosenMeta.innerHTML = "";
            chosenPanel.querySelector(".chosen-img-wrap").innerHTML =
                '<span style="font-size:12px;color:var(--muted,#9ca3af);text-align:center;padding:0 12px;">Pick an artist, then an artwork to see its details here.</span>';
            renderResults([]);
            updateRuleLabel(null);
        });

        // Once user selects an artwork, they will then be able to choose a filter
        artworkSelect.addEventListener("change", () => {
            const artworkId = artworkSelect.value;

            // Used for error checking, but should never go in here (realistically)
            if (!artworkId) {
                filterSelect.disabled = true;
                btnSubmit.disabled = true;
                renderResults([]);
                updateRuleLabel(null);
                return;
            }

            filterSelect.disabled = false;
            btnSubmit.disabled = false;
            renderchosen(artworkId);
        });

        // Once all of our 3 dropdowns have been populated, user can click the submit button
        // This will then populate the Results with artworks (if any match the criteria)
        btnSubmit.addEventListener("click", () => {
            const artist    = artistSelect.value;
            const artworkId = artworkSelect.value;
            const rule      = filterSelect.value || "most-similar";
            if (!artist || !artworkId) return;

            const results = computeResults(artist, artworkId, rule);
            updateRuleLabel(rule);
            renderchosen(artworkId);
            renderResults(results);
        });

        // If the user click the "Random" button then we will auto-populate the 3 dropdowns
        // And then display proper results
        btnRandom.addEventListener("click", () => {
            if (edges.length === 0) return;

            const e = edges[Math.floor(Math.random() * edges.length)];
            const chosenId     = e.aId;                 // treat query side as the main artwork
            const chosenArtist = e.aArtist || "Unknown";

            if (!chosenId || !chosenArtist) return;

            artistSelect.value = chosenArtist;
            populateArtworksForArtist(chosenArtist);
            artworkSelect.disabled = false;
            artworkSelect.value = chosenId;
            filterSelect.disabled = false;
            btnSubmit.disabled = false;

            const rule = "most-similar";
            filterSelect.value = rule;

            const results = computeResults(chosenArtist, chosenId, rule);
            updateRuleLabel(rule);
            renderchosen(chosenId);
            renderResults(results);
        });

        // If the user clicks on our "Reset" button, we will clear out all the fields
        btnReset.addEventListener("click", () => {
            artistSelect.value = "";
            artworkSelect.innerHTML = '<option value="">— Select an artwork —</option>';
            artworkSelect.disabled = true;
            filterSelect.disabled  = true;
            btnSubmit.disabled     = true;
            filterSelect.value     = "most-similar";

            chosenMeta.innerHTML = "";
            chosenPanel.querySelector(".chosen-img-wrap").innerHTML =
                '<span style="font-size:12px;color:var(--muted,#9ca3af);text-align:center;padding:0 12px;">Pick an artist, then an artwork to see its details here.</span>';

            renderResults([]);
            updateRuleLabel(null);
        });


        // Loading artwork metadata from CSV
        // We then build out our references by ID and artist
        d3.dsv(",", CSV_PATH, parseRow)
            .then(rows => {
                buildIndexes(rows);
                populateArtists();
            })
            .catch(err => {
                console.error("Failed to load dataset:", err);
            });
    })();
</script>
</body>
</html>
